'use strict';

/*

  Component need to interact with other components

  METHOD 1: Use Callbacks

    - function that translated to somewhere
    - expect that it will be executed after some `event`

  Example:

  function Menu() {
    ...
    function select(link) {
      options.onselect(link.getAttribute('href').slice(1));
      ...
    }
  ...
  }

  var menu = new Menu({
    title: "Сладости",
    template: _.template(document.getElementById('menu-template').innerHTML),
    listTemplate: _.template(document.getElementById('menu-list-template').innerHTML),
    items: {
      "donut": "Пончик",
      "cake": "Пирожное",
      "chocolate": "Шоколадка"
    },
    onselect: showSelected //!!!translate callback
  });

  function showSelected(href) {
    alert(href);
  }



  
  METHOD 2: Use Custom Events

    - generate and dispatch
    - listen to event and handle it


  Example: 


  function Menu(options) {

    function select(link) {
      var widgetEvent = new CustomEvent("select", {
        bubbles: true,
        // detail - стандартное свойство CustomEvent для произвольных данных
        detail: link.getAttribute('href').slice(1)
      });
      elem.dispatchEvent(widgetEvent);
    }

  }


  var menu = new Menu(...);

  var elem = menu.getElem();

  elem.addEventListener('select', function(event) { //!!!listen to custom event
    alert( event.detail );  
  });

*/

/*Task 1  
  
  Добавьте событие в голосовалку, созданную в задаче Голосовалка, используя механизм генерации событий на объекте.
  Пусть каждое изменение голоса сопровождается событием change со свойством detail, содержащим обновлённое значение:

*/

function task1() {

  var Voter = stampit().props({
    elem: '',
    id: _.uniqueId('voter-')
  }).methods({
    _generateChangeEvent: function _generateChangeEvent(data) {
      var evt = new CustomEvent('change', {
        bubbles: true,
        detail: data
      });
      this.$vote.dispatchEvent(evt);
    },

    _replaceHTML: function _replaceHTML(elem) {
      elem.insertAdjacentHTML('beforeBegin', this.html);
      elem.parentElement.removeChild(this.elem);
      elem = document.getElementById(this.id);
      return elem;
    },
    _handleClick: function _handleClick(e) {
      var vote = parseInt(this.$vote.textContent);
      var isTarget = function isTarget(type) {
        return e.target.classList.contains(type);
      };
      if (isTarget('down')) this.setVote(--vote);else if (isTarget('up')) this.setVote(++vote);else return;
    },
    setVote: function setVote(vote) {
      this.$vote.textContent = vote;
      this._generateChangeEvent(vote);
    }
  }).init(function () {
    var _this = this;

    this.html = '<div id="' + this.id + '" class="voter">\n                     <span class="down">—</span>\n                     <span class="vote">0</span>\n                     <span class="up">+</span>\n                   </div>';
    var elem = this._replaceHTML(this.elem);
    this.$vote = elem.querySelector('.vote');

    elem.addEventListener('click', function (e) {
      _this._handleClick(e);
    });

    return this;
  });

  var voter = new Voter({
    elem: document.getElementById('voter'),
    id: 'voter'
  });

  document.getElementById('voter').addEventListener('change', function (e) {
    alert(e.detail); // новое значение голоса
  });

  voter.setVote(5);
}
// task1()

/*Task 3

Перепишите решение задачи Список с выделением в виде компонента.
У компонента должен быть единственный публичный метод getSelected(),
который возвращает выбранные значения в виде массива.

Добавьте в решение задачи Компонент: список с выделением событие select.
Оно должно срабатывать при каждом изменении выбора и в свойстве detail содержать список выбранных строк.
Во внешнем коде добавьте обработчик к списку, который при изменениях выводит список значений.

*/

function task2() {

  var SelectableList = stampit().refs({
    element: null,
    onSelect: null,
    selectedClass: 'selected'
  }).init(function (_ref) {
    var _this2 = this;

    var instance = _ref.instance;
    var stamp = _ref.stamp;
    var args = _ref.args;

    var lastSelectedIdx = 0,
        findItemIdx = function findItemIdx(item, items) {
      return _.indexOf(items, item);
    },
        getSelectedItems = function getSelectedItems() {
      return $('.' + _this2.selectedClass, _this2.element);
    };

    var hltBulk = function hltBulk(item, items) {
      var crtItemIdx = findItemIdx(item, items);
      _(items).filter(function (i, idx) {
        if (lastSelectedIdx > crtItemIdx) {
          return idx <= lastSelectedIdx && idx >= crtItemIdx;
        } else {
          return idx >= lastSelectedIdx && idx <= crtItemIdx;
        }
      }).forEach(function (itm) {
        itm.classList.add(_this2.selectedClass);
      }).value();
    };

    var hltCurrent = function hltCurrent(item, items) {
      _.forEach(items, function (item) {
        item.classList.remove(_this2.selectedClass);
      });
      item.classList.add(_this2.selectedClass);
      lastSelectedIdx = findItemIdx(item, items);
    };

    var toggleCurrent = function toggleCurrent(item, items) {
      item.classList.toggle(_this2.selectedClass);
      lastSelectedIdx = findItemIdx(item, items);
    };

    var handleClick = function handleClick(evt) {
      var crtItem = evt.target;
      var allItems = event.currentTarget.children;

      if (crtItem.tagName !== 'LI') return;

      if (evt.metaKey || evt.ctrlKey) toggleCurrent(crtItem, allItems);else if (evt.shiftKey) hltBulk(crtItem, allItems);else hltCurrent(crtItem, allItems);

      _this2.onSelect(getSelectedItems());
    };

    this.element.addEventListener('click', handleClick);
  });

  var list = SelectableList({
    element: document.getElementById('list'),
    onSelect: function onSelect(selectedItems) {
      console.log('----------');
      $$(selectedItems).forEach(function (i) {
        return console.log(i);
      });
    }
  });
}
task2();

/*Task 2

Напишите свой, самостоятельно оформленный, селект.

Требования:

Открытие и закрытие по клику на заголовок.
Закрытие селекта происходит при выборе или клике на любое другое место документа, в том числе на другой аналогичный селект.
Событие "select" при выборе опции возникает на элементе селекта и всплывает.
Значение опции хранится в атрибуте data-value (HTML-структура есть в исходном документе).

*/

function task3() {

  var Select = stampit().refs({
    element: null,
    options: []
  }).static({
    template: '<span class="select-current"><%= current %></span>\n          <ul class="select-items">\n            <% options.forEach(option => { %>\n              <li class="select-item"><%= option %></li>\n            <% }) %>\n          </li>'
  }).methods({
    render: function render() {
      var tpl = _.template(Select.template)({
        current: this.options[0],
        options: this.options
      });

      this.element.insertAdjacentHTML('afterBegin', tpl);
      this.element.classList.add('select');
    },
    open: function open() {
      this.element.classList.add('is-opened');
    },
    close: function close() {
      this.element.classList.remove('is-opened');
    },
    setItem: function setItem(txt) {
      var current = this.element.querySelector('.select-current');
      current.textContent = txt;

      var evt = new CustomEvent('select', {
        bubbles: true,
        detail: txt
      });

      current.dispatchEvent(evt);
    }
  }).init(function () {
    var _this3 = this;

    var isHasClass = function isHasClass(elem, cls) {
      return elem.classList.contains(cls);
    };

    this.render();

    document.body.addEventListener('click', function (e) {
      var isTargetClass = _.partial(isHasClass, e.target);
      _this3.close();

      if (isTargetClass('select-current')) {
        _this3.open();
      } else if (isTargetClass('select-item')) {
        _this3.setItem(e.target.textContent);
      }
    });
  });

  var s1 = Select({
    element: document.getElementById('select-1'),
    options: ['Птицы', 'Рыбы', 'Звери', 'Динозавры', 'Одноклеточные']
  });

  var s2 = Select({
    element: document.getElementById('select-2'),
    options: ['Плотоядные', 'Травоядные', 'Всеядные']
  });

  document.addEventListener('select', function (e) {
    document.getElementById('select-value').textContent = 'Last selected value is ' + e.detail;
  });
}
task3();
//# sourceMappingURL=data:application/json;base64,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QUksYUFBYSxDQUFDLGdCQUFnQixDQUFDLEVBQUU7QUFDbkMsZUFBSyxJQUFJLEVBQUUsQ0FBQTtPQUNaLE1BQ0ksSUFBSSxhQUFhLENBQUMsYUFBYSxDQUFDLEVBQUU7QUFDckMsZUFBSyxPQUFPLENBQUMsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxXQUFXLENBQUMsQ0FBQTtPQUNuQztLQUNGLENBQUMsQ0FBQTtHQUNILENBQUMsQ0FBQTs7QUFLSixNQUFJLEVBQUUsR0FBRyxNQUFNLENBQUM7QUFDZCxXQUFPLEVBQUUsUUFBUSxDQUFDLGNBQWMsQ0FBQyxVQUFVLENBQUM7QUFDNUMsV0FBTyxFQUFFLENBQ1AsT0FBTyxFQUNQLE1BQU0sRUFDTixPQUFPLEVBQ1AsV0FBVyxFQUNYLGVBQWUsQ0FDaEI7R0FDRixDQUFDLENBQUE7O0FBRUYsTUFBSSxFQUFFLEdBQUcsTUFBTSxDQUFDO0FBQ2QsV0FBTyxFQUFFLFFBQVEsQ0FBQyxjQUFjLENBQUMsVUFBVSxDQUFDO0FBQzVDLFdBQU8sRUFBRSxDQUNQLFlBQVksRUFDWixZQUFZLEVBQ1osVUFBVSxDQUNYO0dBQ0YsQ0FBQyxDQUFBOztBQUVGLFVBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxRQUFRLEVBQUUsVUFBQyxDQUFDLEVBQUs7QUFDekMsWUFBUSxDQUFDLGNBQWMsQ0FBQyxjQUFjLENBQUMsQ0FDOUIsV0FBVywrQkFBNkIsQ0FBQyxDQUFDLE1BQU0sQUFBRSxDQUFBO0dBQzVELENBQUMsQ0FBQTtDQUVIO0FBQ0QsS0FBSyxFQUFFLENBQUEiLCJmaWxlIjoicGFydDIvY29tcG9uZW50cy8wMy5jYWxsYmFja3MuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuXG4gIENvbXBvbmVudCBuZWVkIHRvIGludGVyYWN0IHdpdGggb3RoZXIgY29tcG9uZW50c1xuXG4gIE1FVEhPRCAxOiBVc2UgQ2FsbGJhY2tzXG5cbiAgICAtIGZ1bmN0aW9uIHRoYXQgdHJhbnNsYXRlZCB0byBzb21ld2hlcmVcbiAgICAtIGV4cGVjdCB0aGF0IGl0IHdpbGwgYmUgZXhlY3V0ZWQgYWZ0ZXIgc29tZSBgZXZlbnRgXG5cbiAgRXhhbXBsZTpcblxuICBmdW5jdGlvbiBNZW51KCkge1xuICAgIC4uLlxuICAgIGZ1bmN0aW9uIHNlbGVjdChsaW5rKSB7XG4gICAgICBvcHRpb25zLm9uc2VsZWN0KGxpbmsuZ2V0QXR0cmlidXRlKCdocmVmJykuc2xpY2UoMSkpO1xuICAgICAgLi4uXG4gICAgfVxuICAuLi5cbiAgfVxuXG4gIHZhciBtZW51ID0gbmV3IE1lbnUoe1xuICAgIHRpdGxlOiBcItCh0LvQsNC00L7RgdGC0LhcIixcbiAgICB0ZW1wbGF0ZTogXy50ZW1wbGF0ZShkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbWVudS10ZW1wbGF0ZScpLmlubmVySFRNTCksXG4gICAgbGlzdFRlbXBsYXRlOiBfLnRlbXBsYXRlKGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdtZW51LWxpc3QtdGVtcGxhdGUnKS5pbm5lckhUTUwpLFxuICAgIGl0ZW1zOiB7XG4gICAgICBcImRvbnV0XCI6IFwi0J/QvtC90YfQuNC6XCIsXG4gICAgICBcImNha2VcIjogXCLQn9C40YDQvtC20L3QvtC1XCIsXG4gICAgICBcImNob2NvbGF0ZVwiOiBcItCo0L7QutC+0LvQsNC00LrQsFwiXG4gICAgfSxcbiAgICBvbnNlbGVjdDogc2hvd1NlbGVjdGVkIC8vISEhdHJhbnNsYXRlIGNhbGxiYWNrXG4gIH0pO1xuXG4gIGZ1bmN0aW9uIHNob3dTZWxlY3RlZChocmVmKSB7XG4gICAgYWxlcnQoaHJlZik7XG4gIH1cblxuXG5cbiAgXG4gIE1FVEhPRCAyOiBVc2UgQ3VzdG9tIEV2ZW50c1xuXG4gICAgLSBnZW5lcmF0ZSBhbmQgZGlzcGF0Y2hcbiAgICAtIGxpc3RlbiB0byBldmVudCBhbmQgaGFuZGxlIGl0XG5cblxuICBFeGFtcGxlOiBcblxuXG4gIGZ1bmN0aW9uIE1lbnUob3B0aW9ucykge1xuXG4gICAgZnVuY3Rpb24gc2VsZWN0KGxpbmspIHtcbiAgICAgIHZhciB3aWRnZXRFdmVudCA9IG5ldyBDdXN0b21FdmVudChcInNlbGVjdFwiLCB7XG4gICAgICAgIGJ1YmJsZXM6IHRydWUsXG4gICAgICAgIC8vIGRldGFpbCAtINGB0YLQsNC90LTQsNGA0YLQvdC+0LUg0YHQstC+0LnRgdGC0LLQviBDdXN0b21FdmVudCDQtNC70Y8g0L/RgNC+0LjQt9Cy0L7Qu9GM0L3Ri9GFINC00LDQvdC90YvRhVxuICAgICAgICBkZXRhaWw6IGxpbmsuZ2V0QXR0cmlidXRlKCdocmVmJykuc2xpY2UoMSlcbiAgICAgIH0pO1xuICAgICAgZWxlbS5kaXNwYXRjaEV2ZW50KHdpZGdldEV2ZW50KTtcbiAgICB9XG5cbiAgfVxuXG5cbiAgdmFyIG1lbnUgPSBuZXcgTWVudSguLi4pO1xuXG4gIHZhciBlbGVtID0gbWVudS5nZXRFbGVtKCk7XG5cbiAgZWxlbS5hZGRFdmVudExpc3RlbmVyKCdzZWxlY3QnLCBmdW5jdGlvbihldmVudCkgeyAvLyEhIWxpc3RlbiB0byBjdXN0b20gZXZlbnRcbiAgICBhbGVydCggZXZlbnQuZGV0YWlsICk7ICBcbiAgfSk7XG5cbiovXG5cblxuLypUYXNrIDEgIFxuICBcbiAg0JTQvtCx0LDQstGM0YLQtSDRgdC+0LHRi9GC0LjQtSDQsiDQs9C+0LvQvtGB0L7QstCw0LvQutGDLCDRgdC+0LfQtNCw0L3QvdGD0Y4g0LIg0LfQsNC00LDRh9C1INCT0L7Qu9C+0YHQvtCy0LDQu9C60LAsINC40YHQv9C+0LvRjNC30YPRjyDQvNC10YXQsNC90LjQt9C8INCz0LXQvdC10YDQsNGG0LjQuCDRgdC+0LHRi9GC0LjQuSDQvdCwINC+0LHRitC10LrRgtC1LlxuICDQn9GD0YHRgtGMINC60LDQttC00L7QtSDQuNC30LzQtdC90LXQvdC40LUg0LPQvtC70L7RgdCwINGB0L7Qv9GA0L7QstC+0LbQtNCw0LXRgtGB0Y8g0YHQvtCx0YvRgtC40LXQvCBjaGFuZ2Ug0YHQviDRgdCy0L7QudGB0YLQstC+0LwgZGV0YWlsLCDRgdC+0LTQtdGA0LbQsNGJ0LjQvCDQvtCx0L3QvtCy0LvRkdC90L3QvtC1INC30L3QsNGH0LXQvdC40LU6XG5cbiovXG5cbmZ1bmN0aW9uIHRhc2sxICgpIHtcbiAgXG4gIGNvbnN0IFZvdGVyID0gc3RhbXBpdCgpXG4gICAgLnByb3BzKHtcbiAgICAgIGVsZW06ICcnLFxuICAgICAgaWQ6IF8udW5pcXVlSWQoJ3ZvdGVyLScpXG4gICAgfSlcbiAgICAubWV0aG9kcyh7XG4gICAgICBfZ2VuZXJhdGVDaGFuZ2VFdmVudDogZnVuY3Rpb24oZGF0YSkge1xuICAgICAgICBsZXQgZXZ0ID0gbmV3IEN1c3RvbUV2ZW50KCdjaGFuZ2UnLCB7XG4gICAgICAgICAgYnViYmxlczogdHJ1ZSxcbiAgICAgICAgICBkZXRhaWw6IGRhdGFcbiAgICAgICAgfSlcbiAgICAgICAgdGhpcy4kdm90ZS5kaXNwYXRjaEV2ZW50KGV2dClcbiAgICAgIH0sXG5cbiAgICAgIF9yZXBsYWNlSFRNTDogZnVuY3Rpb24oZWxlbSkge1xuICAgICAgICBlbGVtLmluc2VydEFkamFjZW50SFRNTCgnYmVmb3JlQmVnaW4nLCB0aGlzLmh0bWwpXG4gICAgICAgIGVsZW0ucGFyZW50RWxlbWVudC5yZW1vdmVDaGlsZCh0aGlzLmVsZW0pXG4gICAgICAgIGVsZW0gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCh0aGlzLmlkKVxuICAgICAgICByZXR1cm4gZWxlbVxuICAgICAgfSxcbiAgICAgIF9oYW5kbGVDbGljazogZnVuY3Rpb24oZSkge1xuICAgICAgICBsZXQgdm90ZSA9IHBhcnNlSW50KHRoaXMuJHZvdGUudGV4dENvbnRlbnQpXG4gICAgICAgIGxldCBpc1RhcmdldCA9IHR5cGUgPT4gZS50YXJnZXQuY2xhc3NMaXN0LmNvbnRhaW5zKHR5cGUpXG4gICAgICAgIGlmIChpc1RhcmdldCgnZG93bicpKSB0aGlzLnNldFZvdGUoLS12b3RlKVxuICAgICAgICBlbHNlIGlmIChpc1RhcmdldCgndXAnKSkgdGhpcy5zZXRWb3RlKCsrdm90ZSlcbiAgICAgICAgZWxzZSByZXR1cm5cbiAgICAgIH0sXG4gICAgICBzZXRWb3RlOiBmdW5jdGlvbih2b3RlKSB7XG4gICAgICAgIHRoaXMuJHZvdGUudGV4dENvbnRlbnQgPSB2b3RlXG4gICAgICAgIHRoaXMuX2dlbmVyYXRlQ2hhbmdlRXZlbnQodm90ZSlcbiAgICAgIH1cbiAgICB9KVxuICAgIC5pbml0KGZ1bmN0aW9uICgpIHtcbiAgICAgIHRoaXMuaHRtbCA9IGA8ZGl2IGlkPVwiJHt0aGlzLmlkfVwiIGNsYXNzPVwidm90ZXJcIj5cbiAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPVwiZG93blwiPuKAlDwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPVwidm90ZVwiPjA8L3NwYW4+XG4gICAgICAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz1cInVwXCI+Kzwvc3Bhbj5cbiAgICAgICAgICAgICAgICAgICA8L2Rpdj5gXG4gICAgICBsZXQgZWxlbSA9IHRoaXMuX3JlcGxhY2VIVE1MKHRoaXMuZWxlbSlcbiAgICAgIHRoaXMuJHZvdGUgPSBlbGVtLnF1ZXJ5U2VsZWN0b3IoJy52b3RlJylcbiAgICAgIFxuICAgICAgZWxlbS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIGUgPT4ge1xuICAgICAgICB0aGlzLl9oYW5kbGVDbGljayhlKVxuICAgICAgfSlcblxuICAgICAgcmV0dXJuIHRoaXNcbiAgICB9KVxuXG5cbiAgbGV0IHZvdGVyID0gbmV3IFZvdGVyKHtcbiAgICBlbGVtOiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm90ZXInKSxcbiAgICBpZDogJ3ZvdGVyJ1xuICB9KTtcblxuICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndm90ZXInKS5hZGRFdmVudExpc3RlbmVyKCdjaGFuZ2UnLCBmdW5jdGlvbihlKSB7XG4gICAgYWxlcnQoIGUuZGV0YWlsICk7IC8vINC90L7QstC+0LUg0LfQvdCw0YfQtdC90LjQtSDQs9C+0LvQvtGB0LBcbiAgfSk7XG5cbiAgdm90ZXIuc2V0Vm90ZSg1KTtcblxufVxuLy8gdGFzazEoKVxuXG5cblxuLypUYXNrIDNcblxu0J/QtdGA0LXQv9C40YjQuNGC0LUg0YDQtdGI0LXQvdC40LUg0LfQsNC00LDRh9C4INCh0L/QuNGB0L7QuiDRgSDQstGL0LTQtdC70LXQvdC40LXQvCDQsiDQstC40LTQtSDQutC+0LzQv9C+0L3QtdC90YLQsC5cbtCjINC60L7QvNC/0L7QvdC10L3RgtCwINC00L7Qu9C20LXQvSDQsdGL0YLRjCDQtdC00LjQvdGB0YLQstC10L3QvdGL0Lkg0L/Rg9Cx0LvQuNGH0L3Ri9C5INC80LXRgtC+0LQgZ2V0U2VsZWN0ZWQoKSxcbtC60L7RgtC+0YDRi9C5INCy0L7Qt9Cy0YDQsNGJ0LDQtdGCINCy0YvQsdGA0LDQvdC90YvQtSDQt9C90LDRh9C10L3QuNGPINCyINCy0LjQtNC1INC80LDRgdGB0LjQstCwLlxuXG7QlNC+0LHQsNCy0YzRgtC1INCyINGA0LXRiNC10L3QuNC1INC30LDQtNCw0YfQuCDQmtC+0LzQv9C+0L3QtdC90YI6INGB0L/QuNGB0L7QuiDRgSDQstGL0LTQtdC70LXQvdC40LXQvCDRgdC+0LHRi9GC0LjQtSBzZWxlY3QuXG7QntC90L4g0LTQvtC70LbQvdC+INGB0YDQsNCx0LDRgtGL0LLQsNGC0Ywg0L/RgNC4INC60LDQttC00L7QvCDQuNC30LzQtdC90LXQvdC40Lgg0LLRi9Cx0L7RgNCwINC4INCyINGB0LLQvtC50YHRgtCy0LUgZGV0YWlsINGB0L7QtNC10YDQttCw0YLRjCDRgdC/0LjRgdC+0Log0LLRi9Cx0YDQsNC90L3Ri9GFINGB0YLRgNC+0LouXG7QktC+INCy0L3QtdGI0L3QtdC8INC60L7QtNC1INC00L7QsdCw0LLRjNGC0LUg0L7QsdGA0LDQsdC+0YLRh9C40Log0Log0YHQv9C40YHQutGDLCDQutC+0YLQvtGA0YvQuSDQv9GA0Lgg0LjQt9C80LXQvdC10L3QuNGP0YUg0LLRi9Cy0L7QtNC40YIg0YHQv9C40YHQvtC6INC30L3QsNGH0LXQvdC40LkuXG5cbiovXG5cbmZ1bmN0aW9uIHRhc2syICgpIHtcbiAgXG4gIGNvbnN0IFNlbGVjdGFibGVMaXN0ID0gc3RhbXBpdCgpXG4gICAgLnJlZnMoe1xuICAgICAgZWxlbWVudDogbnVsbCxcbiAgICAgIG9uU2VsZWN0OiBudWxsLFxuICAgICAgc2VsZWN0ZWRDbGFzczogJ3NlbGVjdGVkJyBcbiAgICB9KVxuICAgIC5pbml0KGZ1bmN0aW9uKHtpbnN0YW5jZSwgc3RhbXAsIGFyZ3N9KSB7XG4gICAgICBsZXQgbGFzdFNlbGVjdGVkSWR4ID0gMFxuICAgICAgICAgLGZpbmRJdGVtSWR4ID0gKGl0ZW0sIGl0ZW1zKSA9PiBfLmluZGV4T2YoaXRlbXMsIGl0ZW0pXG4gICAgICAgICAsZ2V0U2VsZWN0ZWRJdGVtcyA9ICgpID0+ICQoYC4ke3RoaXMuc2VsZWN0ZWRDbGFzc31gLCB0aGlzLmVsZW1lbnQpXG4gICAgICBcbiAgICAgIGxldCBobHRCdWxrID0gKGl0ZW0sIGl0ZW1zKSA9PiB7XG4gICAgICAgIGxldCBjcnRJdGVtSWR4ID0gZmluZEl0ZW1JZHgoaXRlbSwgaXRlbXMpXG4gICAgICAgIF8oaXRlbXMpXG4gICAgICAgICAgLmZpbHRlcigoaSwgaWR4KSA9PiB7XG4gICAgICAgICAgICBpZiAobGFzdFNlbGVjdGVkSWR4ID4gY3J0SXRlbUlkeCkge1xuICAgICAgICAgICAgICByZXR1cm4gaWR4IDw9IGxhc3RTZWxlY3RlZElkeCAmJiBpZHggPj0gY3J0SXRlbUlkeFxuICAgICAgICAgICAgfSBcbiAgICAgICAgICAgIGVsc2Uge1xuICAgICAgICAgICAgICByZXR1cm4gaWR4ID49IGxhc3RTZWxlY3RlZElkeCAmJiBpZHggPD0gY3J0SXRlbUlkeFxuICAgICAgICAgICAgfVxuICAgICAgICAgIH0pLmZvckVhY2goaXRtID0+IHtcbiAgICAgICAgICAgIGl0bS5jbGFzc0xpc3QuYWRkKHRoaXMuc2VsZWN0ZWRDbGFzcylcbiAgICAgICAgICB9KS52YWx1ZSgpXG4gICAgICAgIH1cblxuICAgICAgbGV0IGhsdEN1cnJlbnQgPSAoaXRlbSwgaXRlbXMpID0+IHtcbiAgICAgICAgXy5mb3JFYWNoKGl0ZW1zLCBpdGVtID0+IHtcbiAgICAgICAgICAgIGl0ZW0uY2xhc3NMaXN0LnJlbW92ZSh0aGlzLnNlbGVjdGVkQ2xhc3MpXG4gICAgICAgICAgfSlcbiAgICAgICAgaXRlbS5jbGFzc0xpc3QuYWRkKHRoaXMuc2VsZWN0ZWRDbGFzcylcbiAgICAgICAgbGFzdFNlbGVjdGVkSWR4ID0gZmluZEl0ZW1JZHgoaXRlbSwgaXRlbXMpXG4gICAgICB9XG5cbiAgICAgIGxldCB0b2dnbGVDdXJyZW50ID0gKGl0ZW0sIGl0ZW1zKSA9PiB7XG4gICAgICAgIGl0ZW0uY2xhc3NMaXN0LnRvZ2dsZSh0aGlzLnNlbGVjdGVkQ2xhc3MpXG4gICAgICAgIGxhc3RTZWxlY3RlZElkeCA9IGZpbmRJdGVtSWR4KGl0ZW0sIGl0ZW1zKVxuICAgICAgfVxuXG5cbiAgICAgIGxldCBoYW5kbGVDbGljayA9IChldnQpID0+IHtcbiAgICAgICAgbGV0IGNydEl0ZW0gID0gZXZ0LnRhcmdldFxuICAgICAgICBsZXQgYWxsSXRlbXMgPSBldmVudC5jdXJyZW50VGFyZ2V0LmNoaWxkcmVuXG5cbiAgICAgICAgaWYgKGNydEl0ZW0udGFnTmFtZSAhPT0gJ0xJJykgcmV0dXJuXG5cbiAgICAgICAgaWYgKGV2dC5tZXRhS2V5IHx8IGV2dC5jdHJsS2V5KSB0b2dnbGVDdXJyZW50KGNydEl0ZW0sIGFsbEl0ZW1zKVxuICAgICAgICBlbHNlIGlmIChldnQuc2hpZnRLZXkpICAgICAgICAgIGhsdEJ1bGsoY3J0SXRlbSwgYWxsSXRlbXMpXG4gICAgICAgIGVsc2UgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGx0Q3VycmVudChjcnRJdGVtLCBhbGxJdGVtcylcblxuICAgICAgICB0aGlzLm9uU2VsZWN0KGdldFNlbGVjdGVkSXRlbXMoKSlcbiAgICAgIH1cblxuICAgICAgdGhpcy5lbGVtZW50LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgaGFuZGxlQ2xpY2spXG5cbiAgICB9KVxuICBcbiAgXG5cbiAgbGV0IGxpc3QgPSBTZWxlY3RhYmxlTGlzdCh7XG4gICAgZWxlbWVudDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xpc3QnKSxcbiAgICBvblNlbGVjdDogZnVuY3Rpb24oc2VsZWN0ZWRJdGVtcykge1xuICAgICAgY29uc29sZS5sb2coJy0tLS0tLS0tLS0nKVxuICAgICAgJCQoc2VsZWN0ZWRJdGVtcykuZm9yRWFjaChpID0+IGNvbnNvbGUubG9nKGkpKVxuICAgIH1cbiAgfSlcblxufVxudGFzazIoKVxuXG5cbi8qVGFzayAyXG5cbtCd0LDQv9C40YjQuNGC0LUg0YHQstC+0LksINGB0LDQvNC+0YHRgtC+0Y/RgtC10LvRjNC90L4g0L7RhNC+0YDQvNC70LXQvdC90YvQuSwg0YHQtdC70LXQutGCLlxuXG7QotGA0LXQsdC+0LLQsNC90LjRjzpcblxu0J7RgtC60YDRi9GC0LjQtSDQuCDQt9Cw0LrRgNGL0YLQuNC1INC/0L4g0LrQu9C40LrRgyDQvdCwINC30LDQs9C+0LvQvtCy0L7Qui5cbtCX0LDQutGA0YvRgtC40LUg0YHQtdC70LXQutGC0LAg0L/RgNC+0LjRgdGF0L7QtNC40YIg0L/RgNC4INCy0YvQsdC+0YDQtSDQuNC70Lgg0LrQu9C40LrQtSDQvdCwINC70Y7QsdC+0LUg0LTRgNGD0LPQvtC1INC80LXRgdGC0L4g0LTQvtC60YPQvNC10L3RgtCwLCDQsiDRgtC+0Lwg0YfQuNGB0LvQtSDQvdCwINC00YDRg9Cz0L7QuSDQsNC90LDQu9C+0LPQuNGH0L3Ri9C5INGB0LXQu9C10LrRgi5cbtCh0L7QsdGL0YLQuNC1IFwic2VsZWN0XCIg0L/RgNC4INCy0YvQsdC+0YDQtSDQvtC/0YbQuNC4INCy0L7Qt9C90LjQutCw0LXRgiDQvdCwINGN0LvQtdC80LXQvdGC0LUg0YHQtdC70LXQutGC0LAg0Lgg0LLRgdC/0LvRi9Cy0LDQtdGCLlxu0JfQvdCw0YfQtdC90LjQtSDQvtC/0YbQuNC4INGF0YDQsNC90LjRgtGB0Y8g0LIg0LDRgtGA0LjQsdGD0YLQtSBkYXRhLXZhbHVlIChIVE1MLdGB0YLRgNGD0LrRgtGD0YDQsCDQtdGB0YLRjCDQsiDQuNGB0YXQvtC00L3QvtC8INC00L7QutGD0LzQtdC90YLQtSkuXG5cbiovXG5cbmZ1bmN0aW9uIHRhc2szICgpIHtcbiAgXG4gIGNvbnN0IFNlbGVjdCA9IHN0YW1waXQoKVxuICAgIC5yZWZzKHtcbiAgICAgIGVsZW1lbnQ6IG51bGwsXG4gICAgICBvcHRpb25zOiBbXVxuICAgIH0pXG4gICAgLnN0YXRpYyh7XG4gICAgICB0ZW1wbGF0ZTogXG4gICAgICAgIGA8c3BhbiBjbGFzcz1cInNlbGVjdC1jdXJyZW50XCI+PCU9IGN1cnJlbnQgJT48L3NwYW4+XG4gICAgICAgICAgPHVsIGNsYXNzPVwic2VsZWN0LWl0ZW1zXCI+XG4gICAgICAgICAgICA8JSBvcHRpb25zLmZvckVhY2gob3B0aW9uID0+IHsgJT5cbiAgICAgICAgICAgICAgPGxpIGNsYXNzPVwic2VsZWN0LWl0ZW1cIj48JT0gb3B0aW9uICU+PC9saT5cbiAgICAgICAgICAgIDwlIH0pICU+XG4gICAgICAgICAgPC9saT5gXG4gICAgfSlcbiAgICAubWV0aG9kcyh7XG4gICAgICByZW5kZXI6IGZ1bmN0aW9uKCkge1xuICAgICAgICBsZXQgdHBsID0gXy50ZW1wbGF0ZShTZWxlY3QudGVtcGxhdGUpKHtcbiAgICAgICAgICBjdXJyZW50OiB0aGlzLm9wdGlvbnNbMF0sXG4gICAgICAgICAgb3B0aW9uczogdGhpcy5vcHRpb25zXG4gICAgICAgIH0pXG5cbiAgICAgICAgdGhpcy5lbGVtZW50Lmluc2VydEFkamFjZW50SFRNTCgnYWZ0ZXJCZWdpbicsIHRwbClcbiAgICAgICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5hZGQoJ3NlbGVjdCcpXG4gICAgICB9LFxuICAgICAgb3BlbjogZnVuY3Rpb24oKSB7XG4gICAgICAgIHRoaXMuZWxlbWVudC5jbGFzc0xpc3QuYWRkKCdpcy1vcGVuZWQnKVxuICAgICAgfSxcbiAgICAgIGNsb3NlOiBmdW5jdGlvbigpIHtcbiAgICAgICAgdGhpcy5lbGVtZW50LmNsYXNzTGlzdC5yZW1vdmUoJ2lzLW9wZW5lZCcpXG4gICAgICB9LFxuICAgICAgc2V0SXRlbTogZnVuY3Rpb24odHh0KSB7XG4gICAgICAgIGxldCBjdXJyZW50ID0gdGhpcy5lbGVtZW50LnF1ZXJ5U2VsZWN0b3IoJy5zZWxlY3QtY3VycmVudCcpXG4gICAgICAgIGN1cnJlbnQudGV4dENvbnRlbnQgPSB0eHRcblxuICAgICAgICBsZXQgZXZ0ID0gbmV3IEN1c3RvbUV2ZW50KCdzZWxlY3QnLCB7XG4gICAgICAgICAgYnViYmxlczogdHJ1ZSxcbiAgICAgICAgICBkZXRhaWw6IHR4dFxuICAgICAgICB9KVxuXG4gICAgICAgIGN1cnJlbnQuZGlzcGF0Y2hFdmVudChldnQpXG4gICAgICB9XG4gICAgfSlcbiAgICAuaW5pdChmdW5jdGlvbiAoKSB7XG4gICAgICBsZXQgaXNIYXNDbGFzcyA9IChlbGVtLCBjbHMpID0+IGVsZW0uY2xhc3NMaXN0LmNvbnRhaW5zKGNscylcblxuICAgICAgdGhpcy5yZW5kZXIoKVxuXG4gICAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgKGUpID0+IHtcbiAgICAgICAgbGV0IGlzVGFyZ2V0Q2xhc3MgPSBfLnBhcnRpYWwoaXNIYXNDbGFzcywgZS50YXJnZXQpXG4gICAgICAgIHRoaXMuY2xvc2UoKVxuXG4gICAgICAgIGlmIChpc1RhcmdldENsYXNzKCdzZWxlY3QtY3VycmVudCcpKSB7XG4gICAgICAgICAgdGhpcy5vcGVuKClcbiAgICAgICAgfVxuICAgICAgICBlbHNlIGlmIChpc1RhcmdldENsYXNzKCdzZWxlY3QtaXRlbScpKSB7XG4gICAgICAgICAgdGhpcy5zZXRJdGVtKGUudGFyZ2V0LnRleHRDb250ZW50KVxuICAgICAgICB9XG4gICAgICB9KVxuICAgIH0pXG5cblxuXG5cbiAgbGV0IHMxID0gU2VsZWN0KHtcbiAgICBlbGVtZW50OiBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2VsZWN0LTEnKSxcbiAgICBvcHRpb25zOiBbXG4gICAgICAn0J/RgtC40YbRiycsXG4gICAgICAn0KDRi9Cx0YsnLFxuICAgICAgJ9CX0LLQtdGA0LgnLFxuICAgICAgJ9CU0LjQvdC+0LfQsNCy0YDRiycsXG4gICAgICAn0J7QtNC90L7QutC70LXRgtC+0YfQvdGL0LUnXG4gICAgXVxuICB9KVxuXG4gIGxldCBzMiA9IFNlbGVjdCh7XG4gICAgZWxlbWVudDogZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3NlbGVjdC0yJyksXG4gICAgb3B0aW9uczogW1xuICAgICAgJ9Cf0LvQvtGC0L7Rj9C00L3Ri9C1JyxcbiAgICAgICfQotGA0LDQstC+0Y/QtNC90YvQtScsXG4gICAgICAn0JLRgdC10Y/QtNC90YvQtSdcbiAgICBdXG4gIH0pXG5cbiAgZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignc2VsZWN0JywgKGUpID0+IHtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnc2VsZWN0LXZhbHVlJylcbiAgICAgICAgICAgIC50ZXh0Q29udGVudCA9IGBMYXN0IHNlbGVjdGVkIHZhbHVlIGlzICR7ZS5kZXRhaWx9YFxuICB9KVxuXG59XG50YXNrMygpXG5cbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==
